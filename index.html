<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui;
      margin: 0;
      padding: 28px;
      background: #111;
      color: #fff;
    }
    .big { font-size: 64px; font-weight: 700; }
    .mid { font-size: 34px; margin-top: 18px; }
    .small { font-size: 20px; margin-top: 14px; opacity: 0.7; }
    .danger { background: #7a0000; }
  </style>
</head>

<body id="b">
  <div class="big" id="next">Loading‚Ä¶</div>
  <div class="mid" id="leave"></div>
  <div class="mid" id="arrive"></div>
  <div class="small" id="meta"></div>

  <script>
    // IMPORTANT: paste your /exec URL here
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbxK0bOe9JwfNTsfQXaq9YpMs7Oe3y8-xBQylSYL1-kwlHs48lV1VNHVcBU5r9Fo_zpDSw/exec";
    const REFRESH_MS = 15000;

    function render(d) {
      if (!d || !d.ok) {
        document.getElementById("next").innerText = "No trip found";
        document.getElementById("leave").innerText = (d && d.message) ? d.message : "";
        document.getElementById("arrive").innerText = "";
        document.getElementById("meta").innerText = "";
        document.getElementById("b").className = "";
        return;
      }

      document.getElementById("next").innerText =
        `üöå ${d.route} departs ${d.departsAt} (${d.minsToDepart}m)`;

      document.getElementById("leave").innerText =
        `‚è∞ Leave by ${d.leaveBy} (${d.minsToLeave}m)`;

      document.getElementById("arrive").innerText =
        `‚úÖ Arrive by ${d.arriveBy}`;

      document.getElementById("meta").innerText =
        `Updated ${new Date(d.updatedAt).toLocaleTimeString()} ‚Ä¢ ${d.note || ""}`;

      // Red background when you should be leaving
      document.getElementById("b").className =
        (typeof d.minsToLeave === "number" && d.minsToLeave <= 0) ? "danger" : "";
    }

    // JSONP callback
    window.__busDashCallback = function(data) {
      render(data);
    };

    function load() {
      const url = `${ENDPOINT}?callback=__busDashCallback&_=${Date.now()}`;
      const s = document.createElement("script");
      s.src = url;
      s.onerror = () => render({ ok: false, message: "Error loading backend (check URL / deployment access)" });
      document.body.appendChild(s);
      setTimeout(() => s.remove(), 5000);
    }

    load();
    setInterval(load, REFRESH_MS);
  </script>
</body>
</html>
